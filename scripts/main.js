function showHeightPlot(e){"use strict";for(var t=[],r=[],a=["hour"],o=0;72>=o;o++)a.push(o);activeReading.site=e[0].feature.properties.SITE_ID,activeReading.year=e[0].feature.properties.year,activeReading.rank=e[0].feature.properties.rank,activeReading.date=e[0].feature.properties.date,e.forEach(function(e){var a=String(e.feature.properties.height);-1===t.indexOf(a)&&(t.push(a),r.push([a]));var o=t.indexOf(a);e.feature.geometry.coordinates.forEach(function(e){r[o].push(e[2])})}),r.push(a),chart.load({columns:r,unload:!0})}function trajHighlight(e,t,r){"use strict";"undefined"==typeof r&&(r=!1);var a=e.target.feature.properties;$.isArray(t)||(t=[t]),trajPointLayer.clearLayers();var o=[];trajLayer.eachLayer(function(e){var r=!0;for(var n in t)e.feature.properties[t[n]]!==a[t[n]]&&(r=!1);r===!0?(e.setStyle({weight:4,opacity:1}),o.push(e)):e.setStyle({weight:1,opacity:.2})}),$("#site_id").html(a.SITE_ID),$("#date").html(a.date),$("#rank").html(a.rank),$("#conc").html(a.conc+" ppb"),$("#conc_hour").html(a.concHour),r===!0&&showHeightPlot(o)}function trajUnHighlight(){"use strict";trajLayer.eachLayer(function(e){e.setStyle({weight:3,opacity:.7})}),trajPointLayer.clearLayers(),chart.unload({ids:["1000","100","10"]})}function addTrajectory(e){"use strict";function t(e,t,r){var a="data/trajectories/"+e+"_"+t+"_"+r+".geojson";$.ajax({dataType:"json",url:a,success:function(e){trajLayer.addData(e),trajPointStorage.addData(e),map.fitBounds(trajLayer.getBounds())}})}var r,a,o;e.hasOwnProperty("year")&&(r=$("#monitors").select2("val"),a=$('input[name="rank[]"]:checked').map(function(){return $(this).val()}).get(),o=[e.year]),e.hasOwnProperty("rank")&&(r=$("#monitors").select2("val"),a=[e.rank],o=$('input[name="year[]"]:checked').map(function(){return $(this).val()}).get()),e.hasOwnProperty("SITE_ID")&&(r=[e.SITE_ID],a=$('input[name="rank[]"]:checked').map(function(){return $(this).val()}).get(),o=$('input[name="year[]"]:checked').map(function(){return $(this).val()}).get());for(var n=0;n<o.length;n++)for(var i=0;i<a.length;i++)for(var s=0;s<r.length;s++)t(r[s],o[n],a[i]);map.fitBounds(trajLayer.getBounds())}function removeTrajectory(e){"use strict";function t(e,t,r){e[t].forEach(function(e){trajLayer._layers[r].feature.properties[t]===e&&trajLayer.removeLayer(trajLayer._layers[r])})}function r(e,t,r){e[t].forEach(function(e){trajPointStorage._layers[r].feature.properties[t]===e&&trajPointStorage.removeLayer(trajPointStorage._layers[r])})}var a=Object.keys(e);Object.keys(trajLayer._layers).forEach(function(r){for(var o=0;o<a.length;o++)t(e,a[o],r)}),Object.keys(trajPointStorage._layers).forEach(function(t){for(var o=0;o<a.length;o++)r(e,a[o],t)}),map.fitBounds(0===trajLayer._layers.length?bounds:trajLayer.getBounds())}function addSite(e){"use strict";var t=sites[e];selectedSites[e]=sites[e];var r=L.marker([t.LAT,t.LNG],{icon:monIcon}).toGeoJSON();r.properties=t,siteLayer.addData(r),addTrajectory({SITE_ID:e})}function removeSite(e){"use strict";delete selectedSites[e],Object.keys(siteLayer._layers).forEach(function(t){siteLayer._layers[t].feature.properties.SITE_ID===e&&siteLayer.removeLayer(siteLayer._layers[t])}),removeTrajectory({SITE_ID:[e]})}function resizeMap(){"use strict";document.getElementById("map").style.width=$("#map").parent().width()+"px";var e=.85*Math.min(window.innerHeight,$("#map").parent().width());document.getElementById("map").style.height=e+"px",map.fitBounds(bounds)}var bounds=L.latLngBounds([30.5,-89],[47,-70]),monIcon=L.divIcon({iconSize:10,className:"mon-icon"}),trajStorageIcon=L.divIcon({iconSize:10,className:"traj-storage"}),statesLayer,sites,map,chart,basemap,siteLayer,trajLayer,trajPointLayer,trajPointStorage,selectedSites={},trajLock=!1,activeReading={};$.ajax({dataType:"json",url:"data/states.geojson",success:function(e){"use strict";statesLayer.addData(e)}}),$.ajax({dataType:"json",url:"data/sites.json",success:function(e){"use strict";sites=e;var t=$("#monitors");Object.keys(sites).map(function(e){var r=["09-009-0027","24-033-8003","34-007-1001","34-015-0002","09-003-1003","24-015-0003","09-001-1123","09-011-0124","09-013-1001","09-007-0007","09-001-0017","09-001-3007","09-001-9003"];r.indexOf(e)>-1&&t.append('<option value = "'+e+'">'+e+"</option>")}),t.select2({width:"100%",placeholder:"Select Monitors"}),t.on("change",function(e){e.hasOwnProperty("added")&&addSite(e.added.id),e.hasOwnProperty("removed")&&removeSite(e.removed.id)})}}),map=L.map("map",{}),chart=c3.generate({bindto:"#heightPlot",data:{x:"hour",columns:[[null]],selection:{enabled:!0},onmouseover:function(e){"use strict";trajPointLayer.clearLayers(),trajPointStorage.eachLayer(function(t){t.feature.properties.SITE_ID===activeReading.site&&t.feature.properties.year===activeReading.year&&t.feature.properties.rank===activeReading.rank&&t.feature.properties.age===-e.x&&trajPointLayer.addData(t.toGeoJSON())})}},axis:{y:{label:{text:"Height (m)",position:"outer-middle"}},x:{label:{text:"Hour",position:"outer-center"},min:0,max:72}},color:{pattern:["#0000FF","#FF0000","#00FF00"]},padding:{right:30,top:30},onmouseout:function(){"use strict";trajPointLayer.clearLayers()}}),basemap=L.layerGroup([L.esri.basemapLayer("Gray")]),basemap.addTo(map),statesLayer=L.geoJson(null,{filter:function(e){"use strict";return"18"===e.properties.STATEFP},style:{color:"#66A",weight:"2",fillColor:"#BBF"}}).addTo(map),siteLayer=L.geoJson(null,{pointToLayer:function(e,t){"use strict";return L.marker(t,{icon:monIcon})},onEachFeature:function(e,t){"use strict";t.on({mouseover:function(){},mouseout:function(){}})}}).addTo(map),trajLayer=L.geoJson(null,{filter:function(e){"use strict";return"LineString"===e.geometry.type},onEachFeature:function(e,t){"use strict";t.on({mouseover:function(e){trajLock===!1&&trajHighlight(e,["rank","date","SITE_ID"])},mouseout:function(){trajLock===!1&&trajUnHighlight(),window.setTimeout(300,function(){chart.unselect()})},click:function(e){trajLock=!0,trajHighlight(e,["rank","date","SITE_ID"],!0)}})},style:function(e){"use strict";var t={weight:3,opacity:.7};return t.color=10===e.properties.height?"#00FF00":100===e.properties.height?"#FF0000":"#0000FF",t}}).addTo(map),trajPointStorage=L.geoJson(null,{pointToLayer:function(e,t){"use strict";return L.marker(t,{icon:trajStorageIcon})},filter:function(e){"use strict";return"Point"===e.geometry.type},onEachFeature:function(e,t){"use strict";var r='<table class = "table"><tr><td>Monitor</td><td>'+e.properties.SITE_ID+"</td></tr><tr><td>Date</td><td>"+e.properties.date+"</td></tr><tr><td>Height</td><td>"+e.geometry.coordinates[2]+"m</td></tr><tr><td>Hour</td><td>"+e.properties.age+"</td></tr></table",a=t.bindPopup(r,{closeButton:!1});t.on({mouseover:function(r){trajLock===!1&&trajHighlight(r,["rank","date","SITE_ID"]),activeReading.rank===e.properties.rank&&activeReading.year===e.properties.year&&activeReading.site===e.properties.SITE_ID&&(t.openPopup(a),chart.select(["10","100","1000"],[-1*e.properties.age],!0))},mouseout:function(){trajLock===!1&&trajUnHighlight(),window.setTimeout(300,function(){t.closePopup(a),chart.unselect()})},click:function(e){trajLock=!0,trajHighlight(e,["rank","date","SITE_ID"],!0)}})}}).addTo(map),trajPointLayer=L.geoJson(null,{pointToLayer:function(e,t){"use strict";return L.circleMarker(t,{radius:6})},style:function(e){"use strict";var t={weight:2,opacity:1,fillOpacity:.8};return 10===e.properties.releaseHeight?(t.color="black",t.fillColor="#00FF00"):100===e.properties.releaseHeight?(t.color="black",t.fillColor="#FF0000"):(t.color="black",t.fillColor="#0000FF"),t}}).addTo(map),$(window).resize(function(){"use strict";resizeMap()}),$("#map").on("click",function(){"use strict";trajLock=!1,activeReading={},trajUnHighlight()}),$('input[name="rank[]"]').on("change",function(e){"use strict";e.target.checked?addTrajectory({rank:e.target.value}):removeTrajectory({rank:[e.target.value]})}),$('input[name="year[]"]').on("change",function(e){"use strict";e.target.checked?addTrajectory({year:e.target.value}):removeTrajectory({year:[e.target.value]})}),resizeMap();